package com.akihabara.market.controller;

import com.akihabara.market.model.ProductoOtaku;
import com.akihabara.market.view.InventarioGUI;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.event.*;
import java.util.List;

public class GuiController {
    private final InventarioGUI vista;
    private final ProductoController productoController;

    public InventarioController(InventarioGUI vista) {
        this.vista = vista;
        this.productoController = new ProductoController();
        inicializarEventos();
        cargarProductosEnTabla();
    }

    private void inicializarEventos() {
        vista.getBtnAgregar().addActionListener(e -> agregarProducto());
        vista.getBtnActualizar().addActionListener(e -> actualizarProducto());
        vista.getBtnEliminar().addActionListener(e -> eliminarProducto());
        vista.getBtnLimpiar().addActionListener(e -> limpiarFormulario());
        vista.getTablaProductos().addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent e) {
                cargarProductoSeleccionado();
            }
        });
    }

    private void agregarProducto() {
        try {
            String nombre = vista.getTxtNombre().getText().trim();
            String categoria = vista.getTxtCategoria().getText().trim();
            double precio = Double.parseDouble(vista.getTxtPrecio().getText());
            int stock = Integer.parseInt(vista.getTxtStock().getText());

            if (productoController.agregarProducto(nombre, categoria, precio, stock)) {
                cargarProductosEnTabla();
                limpiarFormulario();
                mostrarMensaje("Producto agregado correctamente.");
            } else {
                mostrarError("No se pudo agregar el producto.");
            }
        } catch (Exception e) {
            mostrarError("Error al agregar producto: " + e.getMessage());
        }
    }

    private void actualizarProducto() {
        try {
            int fila = vista.getTablaProductos().getSelectedRow();
            if (fila == -1) {
                mostrarError("Seleccione un producto para actualizar.");
                return;
            }

            int id = Integer.parseInt(vista.getTxtId().getText());
            String nombre = vista.getTxtNombre().getText().trim();
            String categoria = vista.getTxtCategoria().getText().trim();
            double precio = Double.parseDouble(vista.getTxtPrecio().getText());
            int stock = Integer.parseInt(vista.getTxtStock().getText());

            if (productoController.actualizarProducto(id, nombre, categoria, precio, stock)) {
                cargarProductosEnTabla();
                limpiarFormulario();
                mostrarMensaje("Producto actualizado correctamente.");
            } else {
                mostrarError("No se pudo actualizar el producto.");
            }
        } catch (Exception e) {
            mostrarError("Error al actualizar producto: " + e.getMessage());
        }
    }

    private void eliminarProducto() {
        int fila = vista.getTablaProductos().getSelectedRow();
        if (fila == -1) {
            mostrarError("Seleccione un producto para eliminar.");
            return;
        }

        int id = Integer.parseInt(vista.getTablaProductos().getValueAt(fila, 0).toString());

        int confirm = JOptionPane.showConfirmDialog(vista, "¿Estás seguro de eliminar el producto?", "Confirmar", JOptionPane.YES_NO_OPTION);
        if (confirm == JOptionPane.YES_OPTION) {
            if (productoController.eliminarProducto(id)) {
                cargarProductosEnTabla();
                limpiarFormulario();
                mostrarMensaje("Producto eliminado correctamente.");
            } else {
                mostrarError("No se pudo eliminar el producto.");
            }
        }
    }

    private void cargarProductosEnTabla() {
        List<ProductoOtaku> productos = productoController.listarProductos();
        DefaultTableModel modelo = (DefaultTableModel) vista.getTablaProductos().getModel();
        modelo.setRowCount(0); // Limpiar tabla

        for (ProductoOtaku p : productos) {
            modelo.addRow(new Object[]{
                p.getId(), p.getNombre(), p.getCategoria(), p.getPrecio(), p.getStock()
            });
        }
    }

    private void cargarProductoSeleccionado() {
        int fila = vista.getTablaProductos().getSelectedRow();
        if (fila != -1) {
            vista.getTxtId().setText(vista.getTablaProductos().getValueAt(fila, 0).toString());
            vista.getTxtNombre().setText(vista.getTablaProductos().getValueAt(fila, 1).toString());
            vista.getTxtCategoria().setText(vista.getTablaProductos().getValueAt(fila, 2).toString());
            vista.getTxtPrecio().setText(vista.getTablaProductos().getValueAt(fila, 3).toString());
            vista.getTxtStock().setText(vista.getTablaProductos().getValueAt(fila, 4).toString());
        }
    }

    private void limpiarFormulario() {
        vista.getTxtId().setText("");
        vista.getTxtNombre().setText("");
        vista.getTxtCategoria().setText("");
        vista.getTxtPrecio().setText("");
        vista.getTxtStock().setText("");
        vista.getTablaProductos().clearSelection();
    }

    private void mostrarMensaje(String mensaje) {
        JOptionPane.showMessageDialog(vista, mensaje, "Información", JOptionPane.INFORMATION_MESSAGE);
    }

    private void mostrarError(String error) {
        JOptionPane.showMessageDialog(vista, error, "Error", JOptionPane.ERROR_MESSAGE);
    }
}
